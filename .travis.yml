language: go
dist: trusty
go:
  - 1.11.x
env:
  global:
    secure: "KuhSkwBWX7Hu6UPElqK74FegH4D05aEtimHr/1TJAwKqquzsJvJoM8MRCyfZUunw2+h5GQnP7yGvTGZdfaRXOTIQQqOpaqHQQaaXNALN3pw65TfdaLokwiEfdB+4J5t/YhnLDCn+pyODgDToLyBtw5lubTnNZMQBaoVy20KDGtE+3jCWGPvjDh5YGGeL9KsCakeNdiBwWhZe1uf3mygYzTJpwmAGINtBSZ2Blimt3W9wtPoR3RT7TN6LYlIYYfC2M89XNTGXlcE/y+b0SQqaGgDcC0nxt3rMR1JVPpBD6nupjPh7ypWM4EWaMWiCudRyd1QXYQ/yffRHybGZxEmf6YwCHnN+BL9kQdFo6nkKq390ubDGPwdLsIudcfRBqAI65sxNXfzCOoJr7xMHdHk8HlgmqRSoMZr88PKlzzQSoQekBrpPLNqSnMkBI+6uGsnszi52HCRtBHxSXMpSl6Jkx8H7ShioREw7NUe3Eysx8aHnkX5MMX/AcgUU1d1ow0uzj1Z0zHdfb/FYNXCCkXHAc7ksH6T1k9HPX4GggoVJF6+C+2kXyRnSniEUkPsbCIdkDQeDbNP9HicCVEF6yXOEx6cFUN9aHZNUPhFTVFguH47hiXLd8wM8AMvwRAUbw9nO22jdw/VFPbTnL+3vmaoaijPRZM9OFjjkcsYOZJ1/abQ="

install:
  - go get -u golang.org/x/lint/golint

before_script:
  - set -e
  - go list ./... | grep -v /proto/ | xargs -n 1 golint
  - go tool vet  ./cmd/ ./pkg/
  - git ls-files | grep -v proto |grep ".go$" | xargs gofmt -l | wc -l

script:
  - "./build/build-go.sh"
  - docker build -t nimbess/nimbess-agent .

deploy:
  # Push images to Dockerhub on merge to master
  - provider: script
    on:
      branch: master
    script: >
      bash -c '
      docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS";
      docker push nimbess/nimbess-agent:latest;
      echo done'

